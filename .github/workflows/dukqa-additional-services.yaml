name: DukQa Additional Services CI/CD

permissions:
  id-token: write
  contents: write

on:
  push:
    branches: [main]
    paths:
      - 'services/**'

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  ECR_REPOSITORY: dukqa-platform
  ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
  ARGOCD_USERNAME: ${{ secrets.ARGOCD_USERNAME }}
  ARGOCD_PASSWORD: ${{ secrets.ARGOCD_PASSWORD }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      shipment-service: ${{ steps.changes.outputs.shipment-service }}
      delivery-service: ${{ steps.changes.outputs.delivery-service }}
      insurance-service: ${{ steps.changes.outputs.insurance-service }}
      customer-support-service: ${{ steps.changes.outputs.customer-support-service }}
      document-upload-service: ${{ steps.changes.outputs.document-upload-service }}
      kq-flight-cargo-service: ${{ steps.changes.outputs.kq-flight-cargo-service }}
      kra-integration-service: ${{ steps.changes.outputs.kra-integration-service }}
      notifications-service: ${{ steps.changes.outputs.notifications-service }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            shipment-service:
              - 'services/shipment-service/**'
            delivery-service:
              - 'services/delivery-service/**'
            insurance-service:
              - 'services/insurance-service/**'
            customer-support-service:
              - 'services/customer-support-service/**'
            document-upload-service:
              - 'services/document-upload-service/**'
            kq-flight-cargo-service:
              - 'services/kq-flight-cargo-service/**'
            kra-integration-service:
              - 'services/kra-integration-service/**'
            notifications-service:
              - 'services/notifications-service/**'

  build-shipment-service:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.shipment-service == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-dukqa-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        run: aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="shipment-service-${{ github.sha }}"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG services/shipment-service
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:shipment-service-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:shipment-service-latest

      - name: Update deployment manifest
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull origin main
          sed -i "s|$ECR_REGISTRY/$ECR_REPOSITORY:shipment-service-.*|$ECR_REGISTRY/$ECR_REPOSITORY:shipment-service-${{ github.sha }}|g" production-cluster/cluster-manifests/apps/shipment-service/deployment.yaml
          git add production-cluster/cluster-manifests/apps/shipment-service/deployment.yaml
          git commit -m "Update shipment-service image to ${{ github.sha }}"
          git push

      - name: Sync ArgoCD application
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/argocd
          argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
          argocd app sync dukqa-microservices

  build-delivery-service:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.delivery-service == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-dukqa-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        run: aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="delivery-service-${{ github.sha }}"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG services/delivery-service
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:delivery-service-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:delivery-service-latest

      - name: Update deployment manifest
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull origin main
          sed -i "s|$ECR_REGISTRY/$ECR_REPOSITORY:delivery-service-.*|$ECR_REGISTRY/$ECR_REPOSITORY:delivery-service-${{ github.sha }}|g" production-cluster/cluster-manifests/apps/delivery-service/deployment.yaml
          git add production-cluster/cluster-manifests/apps/delivery-service/deployment.yaml
          git commit -m "Update delivery-service image to ${{ github.sha }}"
          git push

      - name: Sync ArgoCD application
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/argocd
          argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
          argocd app sync dukqa-microservices

  build-insurance-service:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.insurance-service == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-dukqa-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        run: aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="insurance-service-${{ github.sha }}"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG services/insurance-service
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:insurance-service-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:insurance-service-latest

      - name: Update deployment manifest
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull origin main
          sed -i "s|$ECR_REGISTRY/$ECR_REPOSITORY:insurance-service-.*|$ECR_REGISTRY/$ECR_REPOSITORY:insurance-service-${{ github.sha }}|g" production-cluster/cluster-manifests/apps/insurance-service/deployment.yaml
          git add production-cluster/cluster-manifests/apps/insurance-service/deployment.yaml
          git commit -m "Update insurance-service image to ${{ github.sha }}"
          git push

      - name: Sync ArgoCD application
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/argocd
          argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
          argocd app sync dukqa-microservices

  build-customer-support-service:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.customer-support-service == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-dukqa-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        run: aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="customer-support-service-${{ github.sha }}"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG services/customer-support-service
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:customer-support-service-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:customer-support-service-latest

      - name: Update deployment manifest
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull origin main
          sed -i "s|$ECR_REGISTRY/$ECR_REPOSITORY:customer-support-service-.*|$ECR_REGISTRY/$ECR_REPOSITORY:customer-support-service-${{ github.sha }}|g" production-cluster/cluster-manifests/apps/customer-support-service/deployment.yaml
          git add production-cluster/cluster-manifests/apps/customer-support-service/deployment.yaml
          git commit -m "Update customer-support-service image to ${{ github.sha }}"
          git push

      - name: Sync ArgoCD application
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/argocd
          argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
          argocd app sync dukqa-microservices

  build-document-upload-service:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.document-upload-service == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-dukqa-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        run: aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="document-upload-service-${{ github.sha }}"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG services/document-upload-service
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:document-upload-service-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:document-upload-service-latest

      - name: Update deployment manifest
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull origin main
          sed -i "s|$ECR_REGISTRY/$ECR_REPOSITORY:document-upload-service-.*|$ECR_REGISTRY/$ECR_REPOSITORY:document-upload-service-${{ github.sha }}|g" production-cluster/cluster-manifests/apps/document-upload-service/deployment.yaml
          git add production-cluster/cluster-manifests/apps/document-upload-service/deployment.yaml
          git commit -m "Update document-upload-service image to ${{ github.sha }}"
          git push

      - name: Sync ArgoCD application
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/argocd
          argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
          argocd app sync dukqa-microservices

  build-kq-flight-cargo-service:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.kq-flight-cargo-service == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-dukqa-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        run: aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="kq-flight-cargo-service-${{ github.sha }}"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG services/kq-flight-cargo-service
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:kq-flight-cargo-service-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:kq-flight-cargo-service-latest

      - name: Update deployment manifest
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull origin main
          sed -i "s|$ECR_REGISTRY/$ECR_REPOSITORY:kq-flight-cargo-service-.*|$ECR_REGISTRY/$ECR_REPOSITORY:kq-flight-cargo-service-${{ github.sha }}|g" production-cluster/cluster-manifests/apps/kq-flight-cargo-service/deployment.yaml
          git add production-cluster/cluster-manifests/apps/kq-flight-cargo-service/deployment.yaml
          git commit -m "Update kq-flight-cargo-service image to ${{ github.sha }}"
          git push

      - name: Sync ArgoCD application
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/argocd
          argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
          argocd app sync dukqa-microservices

  build-kra-integration-service:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.kra-integration-service == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-dukqa-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        run: aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="kra-integration-service-${{ github.sha }}"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG services/kra-integration-service
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:kra-integration-service-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:kra-integration-service-latest

      - name: Update deployment manifest
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull origin main
          sed -i "s|$ECR_REGISTRY/$ECR_REPOSITORY:kra-integration-service-.*|$ECR_REGISTRY/$ECR_REPOSITORY:kra-integration-service-${{ github.sha }}|g" production-cluster/cluster-manifests/apps/kra-integration-service/deployment.yaml
          git add production-cluster/cluster-manifests/apps/kra-integration-service/deployment.yaml
          git commit -m "Update kra-integration-service image to ${{ github.sha }}"
          git push

      - name: Sync ArgoCD application
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/argocd
          argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
          argocd app sync dukqa-microservices

  build-notifications-service:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.notifications-service == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-dukqa-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        run: aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="notifications-service-${{ github.sha }}"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG services/notifications-service
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:notifications-service-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:notifications-service-latest

      - name: Update deployment manifest
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull origin main
          sed -i "s|$ECR_REGISTRY/$ECR_REPOSITORY:notifications-service-.*|$ECR_REGISTRY/$ECR_REPOSITORY:notifications-service-${{ github.sha }}|g" production-cluster/cluster-manifests/apps/notifications-service/deployment.yaml
          git add production-cluster/cluster-manifests/apps/notifications-service/deployment.yaml
          git commit -m "Update notifications-service image to ${{ github.sha }}"
          git push

      - name: Sync ArgoCD application
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/argocd
          argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
          argocd app sync dukqa-microservices