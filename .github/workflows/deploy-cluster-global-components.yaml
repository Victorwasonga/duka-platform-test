name: ðŸš€ Deploy Cluster Global Components

on:
  push:
    branches: [main]
    paths:
      - 'cluster-global-components/**'
      - 'production-cluster/cluster-manifests/global/**'
      - 'production-cluster/cluster-manifests/argocd/**'
      - 'production-cluster/cluster-manifests/monitoring/**'
      - 'production-cluster/cluster-manifests/infra/**'
      - '.github/workflows/deploy-cluster-global-components.yaml'
  workflow_dispatch:
    inputs:
      deploy_argocd:
        description: 'Deploy ArgoCD'
        required: false
        default: 'true'
        type: boolean
      deploy_monitoring:
        description: 'Deploy Monitoring Stack'
        required: false
        default: 'true'
        type: boolean

env:
  AWS_REGION: us-east-1
  CLUSTER_NAME: duka-eks-cluster

jobs:
  deploy-global-components:
    name: ðŸŒ Deploy Global Components
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: ðŸ§° Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::746387399274:role/GitHubActionsEKSAdmin
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.32.0'

      - name: ðŸŽ¯ Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.CLUSTER_NAME }}
          kubectl cluster-info
          echo "âœ… Connected to EKS cluster"

      - name: ðŸ“¦ Deploy Namespaces
        run: |
          echo "ðŸ—ï¸ Creating namespaces..."
          kubectl apply -f production-cluster/cluster-manifests/global/namespaces.yaml
          kubectl apply -f cluster-global-components/security/namespaces.yaml
          echo "âœ… Namespaces created"

      - name: ðŸ” Deploy RBAC & Security
        run: |
          echo "ðŸ”’ Deploying RBAC and security components..."
          kubectl apply -f production-cluster/cluster-manifests/global/rbac.yaml
          kubectl apply -f production-cluster/cluster-manifests/global/clusterrole.yaml
          kubectl apply -f production-cluster/cluster-manifests/global/clusterrolebinding.yaml
          kubectl apply -f cluster-global-components/rbac/
          echo "âœ… RBAC and security deployed"

      - name: ðŸ’¾ Deploy Storage Components
        run: |
          echo "ðŸ’¾ Deploying storage components..."
          kubectl apply -f production-cluster/cluster-manifests/infra/storageclass.yaml
          kubectl apply -f production-cluster/cluster-manifests/global/secrets-store-csi-driver.yaml
          kubectl apply -f cluster-global-components/storage/
          echo "âœ… Storage components deployed"

      - name: ðŸŒ Deploy Network Components
        run: |
          echo "ðŸŒ Deploying network components..."
          kubectl apply -f production-cluster/cluster-manifests/global/networkpolicy.yaml
          kubectl apply -f production-cluster/cluster-manifests/global/aws-load-balancer-controller.yaml
          kubectl apply -f production-cluster/cluster-manifests/ingress/
          echo "âœ… Network components deployed"

      - name: ðŸ“Š Deploy Monitoring Stack
        if: ${{ github.event.inputs.deploy_monitoring != 'false' }}
        run: |
          echo "ðŸ“Š Deploying monitoring stack..."
          kubectl apply -f production-cluster/cluster-manifests/monitoring/namespace.yaml
          kubectl apply -f production-cluster/cluster-manifests/global/metrics-server.yaml
          kubectl apply -f cluster-global-components/monitoring/
          kubectl apply -f production-cluster/cluster-manifests/monitoring/
          echo "âœ… Monitoring stack deployed"

      - name: ðŸŽ›ï¸ Deploy ArgoCD
        if: ${{ github.event.inputs.deploy_argocd != 'false' }}
        run: |
          echo "ðŸŽ›ï¸ Deploying ArgoCD..."
          kubectl apply -f production-cluster/cluster-manifests/argocd/argocd-install.yaml
          
          # Wait for ArgoCD to be ready
          echo "â³ Waiting for ArgoCD to be ready..."
          kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n argocd || true
          
          # Deploy ArgoCD applications
          kubectl apply -f production-cluster/cluster-manifests/argocd/argocd-project.yaml
          kubectl apply -f production-cluster/cluster-manifests/argocd/app-of-apps.yaml
          kubectl apply -f production-cluster/cluster-manifests/argocd/argocd-apps.yaml
          echo "âœ… ArgoCD deployed"

      - name: ðŸ”§ Deploy Infrastructure Components
        run: |
          echo "ðŸ”§ Deploying infrastructure components..."
          kubectl apply -f production-cluster/cluster-manifests/global/serviceaccount-irsa.yaml
          kubectl apply -f production-cluster/cluster-manifests/global/cluster-autoscaler.yaml
          kubectl apply -f production-cluster/cluster-manifests/global/global-configmap.yaml
          kubectl apply -f production-cluster/cluster-manifests/global/resourcequota.yaml
          echo "âœ… Infrastructure components deployed"

      - name: âœ… Verify Deployments
        run: |
          echo "ðŸ” Verifying all deployments..."
          echo ""
          echo "ðŸ“‹ Namespaces:"
          kubectl get namespaces
          echo ""
          echo "ðŸƒ Running Pods:"
          kubectl get pods -A --field-selector=status.phase=Running
          echo ""
          echo "ðŸ”§ Services:"
          kubectl get svc -A
          echo ""
          echo "ðŸ“Š Storage Classes:"
          kubectl get storageclass
          echo ""
          echo "ðŸŽ¯ ArgoCD Status:"
          kubectl get pods -n argocd || echo "ArgoCD not deployed"
          echo ""
          echo "âœ… All cluster global components deployed successfully!"

      - name: ðŸ“ Generate Deployment Summary
        run: |
          echo "## ðŸš€ Cluster Global Components Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Successfully Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Namespaces and RBAC" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¾ Storage Components (EBS CSI, Storage Classes)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Network Components (ALB Controller, Network Policies)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Monitoring Stack (Metrics Server, Prometheus, Grafana)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ›ï¸ ArgoCD (GitOps Platform)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ Infrastructure Components (Cluster Autoscaler, IRSA)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Cluster Information:" >> $GITHUB_STEP_SUMMARY
          echo "- **Cluster**: ${{ env.CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Kubernetes Version**: $(kubectl version --short --client)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Ready for application deployments!**" >> $GITHUB_STEP_SUMMARY