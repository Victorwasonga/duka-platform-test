name: ğŸ”„ ArgoCD GitOps Sync - dukqa-platform

on:
  workflow_dispatch:
  push:
    paths:
      - 'production-cluster/cluster-manifests/**'
      - '.github/workflows/argocd-sync.yaml'

jobs:
  argocd-sync:
    name: ğŸ”„ Sync GitHub to EKS via ArgoCD
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: ğŸ§° Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::746387399274:role/GitHubActionsEKSAdmin
          aws-region: eu-west-1

      - name: ğŸ”‘ Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region eu-west-1 \
            --name dukqa-platform

      - name: ğŸ§­ Apply ArgoCD Namespace
        run: |
          kubectl apply -f production-cluster/cluster-manifests/argocd/namespace.yaml

      - name: ğŸ§© Install ArgoCD Core
        run: |
          echo "ğŸš€ Installing ArgoCD components..."
          kubectl apply -f production-cluster/cluster-manifests/argocd/argocd-install.yaml

      - name: ğŸ—‚ï¸ Create ArgoCD Project & Applications
        run: |
          echo "ğŸ“¦ Applying ArgoCD project and App-of-Apps definitions..."
          kubectl apply -f production-cluster/cluster-manifests/argocd/argocd-project.yaml
          kubectl apply -f production-cluster/cluster-manifests/gitops/workflows/argocd-app-of-apps.yaml

      - name: ğŸ” Trigger ArgoCD Sync
        run: |
          echo "ğŸ” Triggering ArgoCD sync..."
          kubectl rollout status deploy/argocd-server -n argocd --timeout=300s || true
          kubectl port-forward svc/argocd-server -n argocd 8080:443 &
          sleep 10
          argocd login localhost:8080 --insecure --username admin --password admin || true
          argocd app sync dukqa-platform --prune || true

      - name: âœ… Summary
        run: |
          echo "âœ… ArgoCD GitOps sync completed for dukqa-platform."
          echo "Visit the ArgoCD UI to confirm all apps are healthy and synced."
